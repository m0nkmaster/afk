name: AI Documentation Review

# Trigger on code changes to main, excluding docs-only or examples-only changes
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/doc-review.yml'

env:
  DOC_UPDATE_BRANCH: docs/ai-review-${{ github.sha }}

jobs:
  review-docs:
    name: Review Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for existing doc review PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing=$(gh pr list --state open --label "documentation" --label "ai-review" --json number --jq '.[0].number // empty')
          if [[ -n "$existing" ]]; then
            echo "Existing doc review PR found: #$existing"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Cursor agent CLI
        if: steps.check-pr.outputs.skip != 'true'
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH
          agent --version

      - name: Create review branch
        if: steps.check-pr.outputs.skip != 'true'
        run: |
          git checkout -b "$DOC_UPDATE_BRANCH"

      - name: Run documentation review
        if: steps.check-pr.outputs.skip != 'true'
        id: review
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if [[ -z "$CURSOR_API_KEY" ]]; then
            echo "::warning::CURSOR_API_KEY not set. Skipping AI documentation review."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Run the Cursor agent with the review prompt
          agent -p --force << 'PROMPT_EOF'
          Review the documentation files against the actual codebase for accuracy.
          
          ## Files to review
          
          - README.md
          - AGENTS.md  
          - ROADMAP.md
          - BUGS.md
          - CONTRIBUTING.md
          - docs/*.md
          
          ## Cross-reference against
          
          - src/cli/mod.rs (CLI commands and arguments)
          - src/config/mod.rs (configuration options)
          - src/sources/mod.rs (task sources)
          - The actual project structure in src/
          
          ## What to look for
          
          1. **Incorrect commands** - CLI commands, flags, or options that don't match the code
          2. **Outdated paths** - File or module references that no longer exist
          3. **Wrong config keys** - Configuration options that don't match the actual schema
          4. **Broken examples** - Code examples that wouldn't work
          
          ## Guidelines
          
          - **Be conservative** - Only fix genuine errors, not style preferences
          - **Don't tinker** - If it's accurate, leave it alone
          - **British English** - This project uses UK spelling
          - **Verify first** - Read the actual code before making any change
          
          If the documentation is already accurate, make no changes.
          
          Do NOT commit any changes - just edit the files directly.
          PROMPT_EOF
          
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Check for changes
        if: steps.check-pr.outputs.skip != 'true' && steps.review.outputs.skip != 'true'
        id: changes
        run: |
          if git diff --quiet; then
            echo "No documentation changes made"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Documentation changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Get summary of changes
            changed_files=$(git diff --name-only | tr '\n' ', ' | sed 's/,$//')
            echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-pr.outputs.skip != 'true' && steps.review.outputs.skip != 'true' && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGED_FILES: ${{ steps.changes.outputs.changed_files }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Build a descriptive title from changed files
          file_count=$(echo "${CHANGED_FILES}" | tr ',' '\n' | wc -l | tr -d ' ')
          if [[ $file_count -eq 1 ]]; then
            pr_title="docs: fix inaccuracies in ${CHANGED_FILES}"
          else
            first_file=$(echo "${CHANGED_FILES}" | cut -d',' -f1)
            pr_title="docs: fix inaccuracies in ${first_file} and $((file_count - 1)) other file(s)"
          fi
          
          git add -A
          git commit -m "${pr_title}"
          git push origin "$DOC_UPDATE_BRANCH"
          
          # Build file list for PR body
          file_list=$(echo "${CHANGED_FILES}" | tr ',' '\n' | sed 's/^/- /')
          
          {
            echo "## Documentation Review"
            echo ""
            echo "Automated review detected documentation that was out of sync with the codebase."
            echo ""
            echo "### What was checked"
            echo ""
            echo "- CLI commands and flags against \`src/cli/\`"
            echo "- Configuration keys against \`src/config/mod.rs\`"
            echo "- File paths and project structure against \`src/\`"
            echo "- Code examples for accuracy"
            echo ""
            echo "### Files updated"
            echo ""
            echo "${file_list}"
            echo ""
            echo "### Review checklist"
            echo ""
            echo "- [ ] Changes are accurate (match the actual code)"
            echo "- [ ] Changes are necessary (not cosmetic)"
            echo ""
            echo "---"
            echo ""
            echo "<sub>Triggered by [\`${COMMIT_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA}) Â· [Workflow](.github/workflows/doc-review.yml)</sub>"
          } > /tmp/pr-body.md
          
          # Create PR
          gh pr create \
            --title "${pr_title}" \
            --body-file /tmp/pr-body.md \
            --head "$DOC_UPDATE_BRANCH" \
            --base main
          
          # Try to add labels (ignore failures if labels don't exist)
          gh pr edit --add-label "documentation" || true
          gh pr edit --add-label "ai-review" || true
          
          echo "Pull request created successfully"

      - name: Summary
        if: always()
        run: |
          echo "## Documentation Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.check-pr.outputs.skip }}" == "true" ]]; then
            echo "Skipped: Existing documentation review PR is still open." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.review.outputs.skip }}" == "true" ]]; then
            echo "Skipped: CURSOR_API_KEY not configured." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "Created PR with documentation updates." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Files changed: ${{ steps.changes.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "No documentation changes needed." >> $GITHUB_STEP_SUMMARY
          fi

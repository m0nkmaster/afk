name: AI Documentation Review

# Trigger on code changes to main, excluding docs-only or examples-only changes
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/doc-review.yml'

env:
  DOC_UPDATE_BRANCH: docs/ai-review-${{ github.sha }}

jobs:
  review-docs:
    name: Review Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for existing doc review PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing=$(gh pr list --state open --label "documentation" --label "ai-review" --json number --jq '.[0].number // empty')
          if [[ -n "$existing" ]]; then
            echo "Existing doc review PR found: #$existing"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Cursor agent CLI
        if: steps.check-pr.outputs.skip != 'true'
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH
          agent --version

      - name: Create review branch
        if: steps.check-pr.outputs.skip != 'true'
        run: |
          git checkout -b "$DOC_UPDATE_BRANCH"

      - name: Run documentation review
        if: steps.check-pr.outputs.skip != 'true'
        id: review
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if [[ -z "$CURSOR_API_KEY" ]]; then
            echo "::warning::CURSOR_API_KEY not set. Skipping AI documentation review."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Run the Cursor agent with the review prompt
          agent -p --force << 'PROMPT_EOF'
          Review the documentation files against the actual codebase for accuracy.
          
          ## Files to review
          
          - README.md
          - AGENTS.md  
          - CONTRIBUTING.md
          - docs/*.md
          
          ## Cross-reference against
          
          - src/cli/mod.rs (CLI commands and arguments)
          - src/config/mod.rs (configuration options)
          - src/sources/mod.rs (task sources)
          - The actual project structure in src/
          
          ## What to look for
          
          1. **Incorrect commands** - CLI commands, flags, or options that don't match the code
          2. **Outdated paths** - File or module references that no longer exist
          3. **Wrong config keys** - Configuration options that don't match the actual schema
          4. **Broken examples** - Code examples that wouldn't work
          
          ## Guidelines
          
          - **Be conservative** - Only fix genuine errors, not style preferences
          - **Don't tinker** - If it's accurate, leave it alone
          - **British English** - This project uses UK spelling
          - **Verify first** - Read the actual code before making any change
          
          If the documentation is already accurate, make no changes.
          
          Do NOT commit any changes - just edit the files directly.
          PROMPT_EOF
          
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Check for changes
        if: steps.check-pr.outputs.skip != 'true' && steps.review.outputs.skip != 'true'
        id: changes
        run: |
          if git diff --quiet; then
            echo "No documentation changes made"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Documentation changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Get summary of changes
            changed_files=$(git diff --name-only | tr '\n' ', ' | sed 's/,$//')
            echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-pr.outputs.skip != 'true' && steps.review.outputs.skip != 'true' && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGED_FILES: ${{ steps.changes.outputs.changed_files }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          git commit -m "docs: sync documentation with code changes"
          git push origin "$DOC_UPDATE_BRANCH"
          
          {
            echo "## Automated Documentation Review"
            echo ""
            echo "This PR was automatically generated by the AI documentation review workflow."
            echo ""
            echo "### Trigger"
            echo ""
            echo "Commit: ${COMMIT_SHA}"
            echo ""
            echo "### Files Updated"
            echo ""
            echo "${CHANGED_FILES}"
            echo ""
            echo "### Review Guidelines"
            echo ""
            echo "Please verify that these changes are:"
            echo "- [ ] Accurate - corrections match the actual code behaviour"
            echo "- [ ] Necessary - not just cosmetic or stylistic changes"
            echo "- [ ] Complete - no additional documentation gaps introduced"
            echo ""
            echo "### Details"
            echo ""
            echo "See the diff for specific changes made."
            echo ""
            echo "---"
            echo "*This PR was created by the [doc-review workflow](.github/workflows/doc-review.yml).*"
          } > /tmp/pr-body.md
          
          gh pr create \
            --title "docs: sync documentation with codebase" \
            --body-file /tmp/pr-body.md \
            --label "documentation" \
            --label "ai-review" \
            --head "$DOC_UPDATE_BRANCH" \
            --base main
          
          echo "Pull request created successfully"

      - name: Summary
        if: always()
        run: |
          echo "## Documentation Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.check-pr.outputs.skip }}" == "true" ]]; then
            echo "Skipped: Existing documentation review PR is still open." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.review.outputs.skip }}" == "true" ]]; then
            echo "Skipped: CURSOR_API_KEY not configured." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "Created PR with documentation updates." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Files changed: ${{ steps.changes.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "No documentation changes needed." >> $GITHUB_STEP_SUMMARY
          fi

name: Documentation Validation

# Validate documentation accuracy on code changes
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'README.md'
      - 'AGENTS.md'
      - 'CONTRIBUTING.md'
      - 'docs/**'
      - '.lychee.toml'
      - '.github/workflows/docs-review.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'README.md'
      - 'AGENTS.md'
      - 'CONTRIBUTING.md'
      - 'docs/**'
      - '.lychee.toml'
      - '.github/workflows/docs-review.yml'

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      # Validate rustdoc examples in source code compile correctly
      - name: Validate rustdoc examples
        run: |
          # Build documentation with private items to catch all rustdoc issues
          # This validates:
          # - Code examples in doc comments compile
          # - Internal documentation is correct
          # - All doc links resolve
          cargo doc --document-private-items --no-deps 2>&1 | tee doc-output.txt
          
          # Fail if there are any warnings (rustdoc warnings indicate broken examples)
          if grep -q "^warning:" doc-output.txt; then
            echo "::error::rustdoc warnings found - check code examples in doc comments"
            grep "^warning:" doc-output.txt
            exit 1
          fi

      # Validate CLI command examples in markdown documentation
      - name: Validate CLI examples
        run: ./scripts/validate-examples.sh

      # Check internal links using lychee
      - name: Check internal links
        uses: lycheeverse/lychee-action@v2
        with:
          # Check markdown files for broken internal links
          args: >-
            --offline
            --no-progress
            --include-fragments
            --base .
            README.md
            AGENTS.md
            CONTRIBUTING.md
            docs/**/*.md
          fail: true

      # Validate architecture section matches source tree
      - name: Validate structure
        run: ./scripts/validate-structure.sh

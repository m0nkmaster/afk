name: Documentation Review

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - '*.md'
      - 'docs/**'
      - 'src/**'
      - 'AGENTS.md'
      - '.github/workflows/docs.yml'

jobs:
  check-links:
    name: Check Internal Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check internal markdown links
        run: |
          echo "Checking internal links in markdown files..."
          
          errors=0
          
          # Find all markdown files
          while IFS= read -r -d '' file; do
            # Extract internal links: [text](path) where path doesn't start with http
            grep -oP '\[([^\]]+)\]\((?!https?://)([^)]+)\)' "$file" 2>/dev/null | while read -r match; do
              # Extract the path from the match (allow empty path for anchor-only links)
              link_path=$(echo "$match" | sed -E 's/\[([^\]]+)\]\(([^)#]*)(#[^)]*)?\)/\2/')
              
              # Skip empty paths and anchors-only
              if [[ -z "$link_path" ]] || [[ "$link_path" == "#"* ]]; then
                continue
              fi
              
              # Resolve path relative to the file's directory
              file_dir=$(dirname "$file")
              if [[ "$link_path" == /* ]]; then
                target_path=".$link_path"
              else
                target_path="$file_dir/$link_path"
              fi
              
              # Normalise the path
              target_path=$(realpath -m "$target_path" 2>/dev/null || echo "$target_path")
              
              # Check if the target exists
              if [[ ! -e "$target_path" ]]; then
                echo "::error file=$file::Broken link: $link_path (target not found: $target_path)"
                errors=$((errors + 1))
              fi
            done
          done < <(find . -name '*.md' -not -path './.git/*' -print0)
          
          if [[ $errors -gt 0 ]]; then
            echo "Found $errors broken link(s)"
            exit 1
          fi
          
          echo "All internal links valid"

  check-code-examples:
    name: Validate Code Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Extract and validate Rust code examples
        run: |
          echo "Extracting Rust code examples from documentation..."
          
          # Create a temporary crate for validation
          mkdir -p /tmp/doc-check/src
          cat > /tmp/doc-check/Cargo.toml << 'CARGO_EOF'
          [package]
          name = "doc-check"
          version = "0.1.0"
          edition = "2021"
          CARGO_EOF
          
          # Extract rust code blocks from markdown files
          # Only check blocks that aren't marked as ignore or no_run
          extract_count=0
          
          for md_file in README.md docs/*.md AGENTS.md; do
            if [[ ! -f "$md_file" ]]; then
              continue
            fi
            
            echo "Processing $md_file..."
            
            # Use awk to extract rust code blocks (excluding bash/json/markdown/etc)
            awk '
              /^```rust$/ || /^```rs$/ { in_rust=1; next }
              /^```/ && in_rust { in_rust=0; print "// --- END BLOCK ---"; next }
              in_rust { print }
            ' "$md_file" >> /tmp/doc-check/extracted_rust.rs
            
          done
          
          # Check if we found any Rust code
          if [[ ! -s /tmp/doc-check/extracted_rust.rs ]]; then
            echo "No Rust code examples found in documentation"
            exit 0
          fi
          
          # Wrap in a function to catch most syntax errors
          cat > /tmp/doc-check/src/lib.rs << 'LIB_EOF'
          // Auto-generated from documentation code examples
          // This validates basic syntax only
          
          #![allow(dead_code)]
          #![allow(unused_imports)]
          #![allow(unused_variables)]
          #![allow(unused_mut)]
          
          LIB_EOF
          
          cat /tmp/doc-check/extracted_rust.rs >> /tmp/doc-check/src/lib.rs
          
          echo "Checking Rust syntax..."
          cd /tmp/doc-check
          
          # Just check syntax, don't require it to compile fully
          # Many doc examples won't have the right imports
          if ! rustfmt --check src/lib.rs 2>/dev/null; then
            echo "::warning::Some Rust code examples may have formatting issues"
          fi
          
          echo "Rust code examples checked"

  check-structure:
    name: Validate Documentation Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify AGENTS.md architecture matches code
        run: |
          echo "Checking AGENTS.md references valid paths..."
          
          errors=0
          
          # Extract paths from the architecture section of AGENTS.md
          # Look for lines like "├── mod.rs" or "└── controller.rs" with parent context
          if [[ ! -f "AGENTS.md" ]]; then
            echo "AGENTS.md not found"
            exit 1
          fi
          
          # Check that key directories mentioned in AGENTS.md exist
          key_dirs=(
            "src/cli"
            "src/config"
            "src/bootstrap"
            "src/progress"
            "src/prompt"
            "src/prd"
            "src/runner"
            "src/git"
            "src/feedback"
            "src/parser"
            "src/watcher"
            "src/sources"
          )
          
          for dir in "${key_dirs[@]}"; do
            if [[ ! -d "$dir" ]]; then
              echo "::error::AGENTS.md references $dir but it doesn't exist"
              errors=$((errors + 1))
            fi
          done
          
          # Check that key files mentioned in architecture exist
          key_files=(
            "src/main.rs"
            "src/lib.rs"
            "src/cli/mod.rs"
            "src/config/mod.rs"
            "src/runner/controller.rs"
            "src/sources/mod.rs"
          )
          
          for file in "${key_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "::error::AGENTS.md references $file but it doesn't exist"
              errors=$((errors + 1))
            fi
          done
          
          if [[ $errors -gt 0 ]]; then
            echo "Found $errors structure mismatch(es)"
            exit 1
          fi
          
          echo "AGENTS.md architecture references are valid"

      - name: Check README command examples exist
        run: |
          echo "Checking README command examples..."
          
          # Extract afk commands from README.md
          commands=$(grep -oP '`afk \w+`' README.md | sort -u | sed 's/`//g' | awk '{print $2}')
          
          # Known valid subcommands (from src/cli/mod.rs)
          valid_commands="go init status tasks task done fail reset sync source import prompt verify archive config use update completions"
          
          errors=0
          
          for cmd in $commands; do
            if ! echo "$valid_commands" | grep -qw "$cmd"; then
              echo "::warning::README mentions 'afk $cmd' which may not be a valid command"
            fi
          done
          
          echo "README command check complete"

  docs-success:
    name: Documentation Review Success
    needs: [check-links, check-code-examples, check-structure]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.check-links.result }}" != "success" || 
                "${{ needs.check-code-examples.result }}" != "success" || 
                "${{ needs.check-structure.result }}" != "success" ]]; then
            echo "Some documentation checks failed"
            exit 1
          fi
          echo "All documentation checks passed!"
